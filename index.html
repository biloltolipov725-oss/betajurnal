<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Электронный журнал</title>
    <link rel="icon" href="https://www.shutterstock.com/image-vector/vector-logo-school-600w-427910128.jpg">

    <!-- CSP для GitHub Pages -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' 'unsafe-inline';
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                   font-src 'self' https://cdnjs.cloudflare.com;
                   img-src 'self' data:;">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .login-container, .main-container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }

        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: #3498db;
            outline: none;
        }

        .login-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 14px 20px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background-color: #2980b9;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .main-container {
            display: none;
            flex-direction: column;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .active-tab {
            display: block;
        }

        .navigation {
            display: flex;
            background-color: white;
            border-top: 1px solid #ddd;
        }

        .nav-btn {
            flex: 1;
            padding: 15px 10px;
            background: none;
            border: none;
            font-size: 14px;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-btn i {
            font-size: 18px;
        }

        .nav-btn.active {
            color: #3498db;
            background-color: #f8f9fa;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .schedule {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .lesson {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .lesson:last-child {
            border-bottom: none;
        }

        .lesson-number {
            font-weight: bold;
            color: #3498db;
            min-width: 30px;
        }

        .lesson-name {
            flex: 1;
            margin: 0 15px;
        }

        .lesson-grade {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background-color: #f1f8ff;
            min-width: 40px;
            text-align: center;
        }

        .lesson-5 { background-color: #d4edda; color: #155724; }
        .lesson-4 { background-color: #fff3cd; color: #856404; }
        .lesson-3 { background-color: #ffeaa7; color: #856404; }
        .lesson-2 { background-color: #f8d7da; color: #721c24; }

        .lesson-time {
            color: #7f8c8d;
            font-size: 14px;
            margin-left: 10px;
        }

        .lesson-counter {
            display: inline-block;
            background-color: #e8f4fc;
            color: #3498db;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Статистика */
        .quarter-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .quarter-btn {
            padding: 10px 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .quarter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .stats-table {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .stats-row {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .stats-row.header {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .subject-col {
            flex: 2;
            font-weight: 500;
        }

        .grades-col {
            flex: 3;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .average-col {
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .grade-bubble {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 14px;
            min-width: 25px;
            text-align: center;
        }

        .grade-5 { background-color: #d4edda; color: #155724; }
        .grade-4 { background-color: #fff3cd; color: #856404; }
        .grade-3 { background-color: #ffeaa7; color: #856404; }
        .grade-2 { background-color: #f8d7da; color: #721c24; }

        .overall-average {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
        }

        .overall-average span {
            font-weight: bold;
            color: #3498db;
            font-size: 1.5rem;
        }

        /* Профиль */
        .profile-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .profile-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #3498db;
            background-color: #f1f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            color: #3498db;
        }

        .profile-info {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
        }

        .info-group {
            margin-bottom: 20px;
        }

        .info-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .info-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .save-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        /* Админ-панель */
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-nav-btn {
            padding: 15px 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
            min-width: 150px;
        }

        .admin-nav-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .admin-tab {
            display: none;
        }

        .admin-tab.active-tab {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .students-list {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .student-item:hover {
            background-color: #f8f9fa;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-login {
            font-weight: bold;
            color: #2c3e50;
        }

        .student-password {
            color: #7f8c8d;
            font-family: monospace;
        }

        .edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Оценки учеников */
        .grade-management-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .grade-section {
            margin-bottom: 30px;
        }

        .grade-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .subject-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .subject-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .subject-card h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .grade-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .grade-btn {
            flex: 1;
            padding: 8px 5px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .grade-btn-5 {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .grade-btn-4 {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .grade-btn-3 {
            background-color: #ffeaa7;
            color: #856404;
            border: 2px solid #f7dc6f;
        }

        .grade-btn-2 {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .grade-btn.selected {
            border: 2px solid #2c3e50;
        }

        .student-selector {
            margin-top: 10px;
        }

        .student-selector select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .add-grade-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px 10px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .current-grade-info {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #7f8c8d;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .grades-history {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .history-table tr:hover {
            background-color: #f8f9fa;
        }

        .delete-grade-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-all-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .login-box {
                padding: 30px 20px;
                width: 95%;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .nav-btn span {
                font-size: 12px;
            }

            .lesson {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .lesson-name {
                margin: 0;
            }

            .stats-row {
                flex-direction: column;
                gap: 10px;
            }

            .admin-nav-btn {
                min-width: 120px;
                padding: 12px 15px;
                font-size: 14px;
            }

            .subject-list {
                grid-template-columns: 1fr;
            }

            .grade-buttons {
                flex-wrap: wrap;
            }

            .grade-btn {
                min-width: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Экран входа -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2>Вход в электронный журнал</h2>
            <div class="input-group">
                <label for="loginInput">Логин</label>
                <input type="text" id="loginInput" placeholder="Введите логин">
            </div>
            <div class="input-group">
                <label for="passwordInput">Пароль</label>
                <input type="password" id="passwordInput" placeholder="Введите пароль">
            </div>
            <button class="login-btn" id="loginBtn">Войти</button>
            <div class="error-message" id="errorMessage">Неверный логин или пароль</div>
        </div>
    </div>

    <!-- Основной интерфейс -->
    <div class="main-container" id="mainContainer">
        <div class="header">
            <h1 id="pageTitle">Дневник</h1>
            <div class="user-info">
                <span id="currentUser">Пользователь</span>
                <button class="logout-btn" id="logoutBtn">Выйти</button>
            </div>
        </div>

        <div class="content" id="content">
            <!-- Дневник -->
            <div class="tab-content active-tab" id="diaryTab">
                <div class="day-header">
                    <h2 id="currentDay">Понедельник</h2>
                    <div class="lesson-counter">Уроков сегодня: <span id="lessonCount">8</span></div>
                </div>
                <div class="schedule" id="schedule">
                    <!-- Расписание -->
                </div>
            </div>

            <!-- Статистика -->
            <div class="tab-content" id="statsTab">
                <div class="quarter-selector">
                    <button class="quarter-btn active" data-quarter="1">1-четверть</button>
                    <button class="quarter-btn" data-quarter="2">2-четверть</button>
                    <button class="quarter-btn" data-quarter="3">3-четверть</button>
                    <button class="quarter-btn" data-quarter="4">4-четверть</button>
                </div>

                <div class="stats-table">
                    <div class="stats-row header">
                        <div class="subject-col">Предмет</div>
                        <div class="grades-col">Оценки</div>
                        <div class="average-col">Средний балл</div>
                    </div>
                    <div id="gradesList">
                        <!-- Оценки -->
                    </div>
                </div>

                <div class="overall-average">
                    Средний балл за четверть: <span id="quarterAverage">0.0</span>
                </div>
            </div>

            <!-- Профиль -->
            <div class="tab-content" id="profileTab">
                <div class="profile-container">
                    <div class="profile-photo" id="profilePhoto">
                        <i class="fas fa-user"></i>
                    </div>

                    <div class="profile-info">
                        <div class="info-group">
                            <label for="profileLogin">Логин</label>
                            <input type="text" id="profileLogin" readonly>
                        </div>

                        <div class="info-group">
                            <label for="newPassword">Новый пароль</label>
                            <input type="password" id="newPassword" placeholder="Введите новый пароль">
                        </div>

                        <div class="info-group">
                            <label for="confirmPassword">Подтверждение пароля</label>
                            <input type="password" id="confirmPassword" placeholder="Подтвердите новый пароль">
                        </div>

                        <button class="save-btn" id="saveProfileBtn">Сохранить изменения</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="navigation" id="userNavigation">
            <button class="nav-btn active" data-tab="diaryTab">
                <i class="fas fa-book"></i>
                <span>Дневник</span>
            </button>
            <button class="nav-btn" data-tab="statsTab">
                <i class="fas fa-chart-line"></i>
                <span>Статистика</span>
            </button>
            <button class="nav-btn" data-tab="profileTab">
                <i class="fas fa-user"></i>
                <span>Профиль</span>
            </button>
        </div>
    </div>

    <!-- Интерфейс администратора -->
    <div class="main-container" id="adminContainer">
        <div class="header">
            <h1>Панель администратора</h1>
            <div class="user-info">
                <span>Администратор</span>
                <button class="logout-btn" id="adminLogoutBtn">Выйти</button>
            </div>
        </div>

        <div class="content">
            <div class="admin-nav">
                <button class="admin-nav-btn active" id="adminStudentsBtn">Данные учеников</button>
                <button class="admin-nav-btn" id="adminGradesBtn">Оценки учеников</button>
            </div>

            <!-- Данные учеников -->
            <div class="admin-tab active-tab" id="adminStudentsTab">
                <div class="search-box">
                    <label for="studentSearch" style="display:none;">Поиск ученика</label>
                    <input type="text" id="studentSearch" placeholder="Поиск по логину...">
                </div>

                <div class="students-list" id="studentsList">
                    <!-- Список учеников -->
                </div>
            </div>

            <!-- Оценки учеников -->
            <div class="admin-tab" id="adminGradesTab">
                <div class="grade-management-container">
                    <div class="grade-section">
                        <h3>Выставление оценок (дата: сегодня)</h3>
                        <div class="subject-list" id="subjectList">
                            <!-- Список предметов -->
                        </div>
                    </div>
                </div>

                <div class="grades-history">
                    <button class="delete-all-btn" id="deleteAllGradesBtn">Удалить все оценки</button>
                    <h3>История оценок</h3>
                    <div id="gradesHistoryTable">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Ученик</th>
                                    <th>Предмет</th>
                                    <th>Оценка</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="gradesHistoryBody">
                                <!-- Строки -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Данные пользователей
        const users = {
            "admin": {password: "admin123", role: "admin"},
            "Saidamin": {password: "Pupsik", role: "user"},
            "Shahobiddin": {password: "Pupsik007", role: "user"},
            "Iskandar": {password: "superpupsik007", role: "user"}
        };

        // Расписание
        const schedule = {
            "Понедельник": ["Математика", "Завтрак", "Английский", "Английский", "Физра", "Биология", "Обед", "Химия", "Русс.яз", "Технология"],
            "Вторник": ["Английский", "Завтрак", "Арабский", "Арабский", "Информатика", "Математика", "Обед", "Математика", "Изо"],
            "Среда": ["Арабский", "Завтрак", "Математика", "Воспитание", "Английский", "Английский", "Обед", "История", "География", "Футбол"],
            "Четверг": ["Английский", "Завтрак", "Английский", "Физика", "Узбекский", "История", "Обед", "История Узбекситана", "Химия", "Русский язык"],
            "Пятница": ["Узбекский", "Завтрак", "История", "Литература", "Арабский", "Математика", "Обед", "Биология", "Математика", "География"]
        };

        // Все предметы
        const allSubjects = [
            "Математика", "Английский", "Арабский", "Биология", "Химия",
            "История", "География", "Физра", "Русс.яз", "Информатика",
            "Изо", "Воспитание", "Футбол", "Физика", "Узбекский",
            "История Узбекситана", "Литература", "Технология"
        ];

        // Оценки учеников
        let allStudentGrades = [];

        // Текущий пользователь и состояние
        let currentUser = null;
        let currentDay = "Понедельник";
        let currentQuarter = "1";

        // DOM элементы
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const adminContainer = document.getElementById('adminContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const pageTitle = document.getElementById('pageTitle');
        const currentUserSpan = document.getElementById('currentUser');
        const currentDayElement = document.getElementById('currentDay');
        const scheduleElement = document.getElementById('schedule');
        const lessonCountElement = document.getElementById('lessonCount');
        const gradesListElement = document.getElementById('gradesList');
        const quarterAverageElement = document.getElementById('quarterAverage');
        const profileLoginInput = document.getElementById('profileLogin');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const studentSearchInput = document.getElementById('studentSearch');
        const studentsListElement = document.getElementById('studentsList');
        const adminStudentsBtn = document.getElementById('adminStudentsBtn');
        const adminGradesBtn = document.getElementById('adminGradesBtn');
        const adminStudentsTab = document.getElementById('adminStudentsTab');
        const adminGradesTab = document.getElementById('adminGradesTab');
        const subjectListElement = document.getElementById('subjectList');
        const gradesHistoryBody = document.getElementById('gradesHistoryBody');
        const deleteAllGradesBtn = document.getElementById('deleteAllGradesBtn');

        // Функции
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Безопасная функция перемешивания (без eval)
        function safeShuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = newArray[i];
                newArray[i] = newArray[j];
                newArray[j] = temp;
            }
            return newArray;
        }

        function getRandomSubjects(count) {
            const shuffled = safeShuffleArray(allSubjects);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        function getRandomGrade() {
            const grades = ["2", "3", "4", "5"];
            return grades[Math.floor(Math.random() * grades.length)];
        }

        function initializeDemoGrades() {
            allStudentGrades = [];
            const demoStudents = ["Saidamin", "Shahobiddin", "Iskandar"];
            const currentDate = getCurrentDate();

            demoStudents.forEach(student => {
                const subjects = getRandomSubjects(3);
                subjects.forEach(subject => {
                    const grade = getRandomGrade();
                    allStudentGrades.push({
                        id: Date.now() + Math.random(),
                        student: student,
                        subject: subject,
                        grade: grade,
                        date: currentDate,
                        quarter: "1"
                    });
                });
            });

            saveToLocalStorage();
        }

        function getGradesForDate(student, date) {
            return allStudentGrades.filter(grade =>
                grade.student === student && grade.date === date
            );
        }

        function getGradeForSubjectAndDate(student, subject, date) {
            return allStudentGrades.find(grade =>
                grade.student === student &&
                grade.subject === subject &&
                grade.date === date
            );
        }

        function getGradesBySubject(student, quarter) {
            const gradesBySubject = {};

            allStudentGrades.forEach(grade => {
                if (grade.student === student && grade.quarter === quarter) {
                    if (!gradesBySubject[grade.subject]) {
                        gradesBySubject[grade.subject] = [];
                    }
                    gradesBySubject[grade.subject].push(parseInt(grade.grade));
                }
            });

            return gradesBySubject;
        }

        function formatDate(dateString) {
            if (!dateString) return "—";
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function getQuarterByDate(dateString) {
            const date = new Date(dateString);
            const month = date.getMonth() + 1;

            if (month >= 9 || month <= 1) return "1";
            if (month >= 2 && month <= 4) return "2";
            if (month >= 5 && month <= 7) return "3";
            return "4";
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dayIndex = today.getDay();
            const daysOfWeek = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];
            currentDay = daysOfWeek[dayIndex] || "Понедельник";

            setupEventListeners();
            loadFromLocalStorage();

            if (allStudentGrades.length === 0) {
                initializeDemoGrades();
            }

            showLoginScreen();
        });

        function setupEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            logoutBtn.addEventListener('click', showLoginScreen);
            adminLogoutBtn.addEventListener('click', showLoginScreen);

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const tabTitles = {
                        'diaryTab': 'Дневник',
                        'statsTab': 'Статистика',
                        'profileTab': 'Профиль'
                    };
                    pageTitle.textContent = tabTitles[tabId];
                });
            });

            document.querySelectorAll('.quarter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentQuarter = this.getAttribute('data-quarter');
                    document.querySelectorAll('.quarter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateGrades();
                });
            });

            saveProfileBtn.addEventListener('click', saveProfile);

            adminStudentsBtn.addEventListener('click', function() {
                switchAdminTab('adminStudentsTab');
                updateAdminNavButtons(this);
            });

            adminGradesBtn.addEventListener('click', function() {
                switchAdminTab('adminGradesTab');
                updateAdminNavButtons(this);
                updateSubjectsForGrades();
                updateGradesHistory();
            });

            studentSearchInput.addEventListener('input', filterStudents);

            deleteAllGradesBtn.addEventListener('click', deleteAllGrades);
        }

        function updateAdminNavButtons(activeButton) {
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            activeButton.classList.add('active');
        }

        function handleLogin() {
            const login = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (users[login] && users[login].password === password) {
                currentUser = login;
                document.getElementById('loginInput').value = '';
                document.getElementById('passwordInput').value = '';
                errorMessage.style.display = 'none';

                if (users[login].role === 'admin') {
                    showAdminInterface();
                } else {
                    showUserInterface();
                }

                saveToLocalStorage();
            } else {
                errorMessage.style.display = 'block';
            }
        }

        function showLoginScreen() {
            loginContainer.style.display = 'flex';
            mainContainer.style.display = 'none';
            adminContainer.style.display = 'none';
            currentUser = null;
        }

        function showUserInterface() {
            loginContainer.style.display = 'none';
            mainContainer.style.display = 'flex';
            adminContainer.style.display = 'none';
            currentUserSpan.textContent = currentUser;
            updateDiary();
            updateProfile();
            updateGrades();
            switchTab('diaryTab');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn[data-tab="diaryTab"]').classList.add('active');
            pageTitle.textContent = 'Дневник';
        }

        function showAdminInterface() {
            loginContainer.style.display = 'none';
            mainContainer.style.display = 'none';
            adminContainer.style.display = 'flex';
            updateStudentsList();
            updateSubjectsForGrades();
            updateGradesHistory();
            switchAdminTab('adminStudentsTab');
            adminStudentsBtn.classList.add('active');
            adminGradesBtn.classList.remove('active');
        }

        function updateSubjectsForGrades() {
            subjectListElement.innerHTML = '';
            const studentList = Object.keys(users).filter(username => users[username].role === 'user');
            const currentDate = getCurrentDate();

            allSubjects.forEach(subject => {
                const subjectCard = document.createElement('div');
                subjectCard.className = 'subject-card';

                subjectCard.innerHTML = `
                    <h4>${subject}</h4>
                    <div class="grade-selector">
                        <div class="grade-buttons">
                            <button class="grade-btn grade-btn-5" data-grade="5">5</button>
                            <button class="grade-btn grade-btn-4" data-grade="4">4</button>
                            <button class="grade-btn grade-btn-3" data-grade="3">3</button>
                            <button class="grade-btn grade-btn-2" data-grade="2">2</button>
                        </div>
                        <div class="student-selector">
                            <select class="student-select" data-subject="${subject}">
                                <option value="">-- Выберите ученика --</option>
                                ${studentList.map(student => `<option value="${student}">${student}</option>`).join('')}
                            </select>
                        </div>
                        <button class="add-grade-btn" data-subject="${subject}">Поставить оценку</button>
                        <div class="current-grade-info" id="grade-info-${subject.replace(/\s+/g, '-')}">
                            Дата: ${formatDate(currentDate)}
                        </div>
                    </div>
                `;

                subjectListElement.appendChild(subjectCard);

                const gradeButtons = subjectCard.querySelectorAll('.grade-btn');
                gradeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        gradeButtons.forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });

                const studentSelect = subjectCard.querySelector('.student-select');
                studentSelect.addEventListener('change', function() {
                    const student = this.value;
                    const subject = this.dataset.subject;
                    updateCurrentGradeInfo(student, subject);
                });

                const addGradeBtn = subjectCard.querySelector('.add-grade-btn');
                addGradeBtn.addEventListener('click', function() {
                    const subject = this.dataset.subject;
                    const studentSelect = subjectCard.querySelector('.student-select');
                    const student = studentSelect.value;
                    const selectedGradeBtn = subjectCard.querySelector('.grade-btn.selected');

                    if (!student) {
                        alert('Выберите ученика!');
                        return;
                    }

                    if (!selectedGradeBtn) {
                        alert('Выберите оценку!');
                        return;
                    }

                    const grade = selectedGradeBtn.dataset.grade;
                    addGradeDirectly(student, subject, grade);

                    gradeButtons.forEach(b => b.classList.remove('selected'));
                    studentSelect.value = '';
                    updateCurrentGradeInfo(student, subject);
                });
            });

            updateAllCurrentGradeInfo();
        }

        function updateCurrentGradeInfo(student, subject) {
            if (!student || !subject) return;

            const currentDate = getCurrentDate();
            const existingGrade = getGradeForSubjectAndDate(student, subject, currentDate);
            const gradeInfoElement = document.getElementById(`grade-info-${subject.replace(/\s+/g, '-')}`);

            if (existingGrade) {
                gradeInfoElement.innerHTML = `Ученик ${student} уже имеет оценку <span class="grade-bubble grade-${existingGrade.grade}">${existingGrade.grade}</span><br>Дата: ${formatDate(currentDate)}`;
            } else {
                gradeInfoElement.innerHTML = `Ученик ${student} - нет оценки<br>Дата: ${formatDate(currentDate)}`;
            }
        }

        function updateAllCurrentGradeInfo() {
            const studentSelects = document.querySelectorAll('.student-select');
            studentSelects.forEach(select => {
                if (select.value) {
                    updateCurrentGradeInfo(select.value, select.dataset.subject);
                }
            });
        }

        function addGradeDirectly(student, subject, grade) {
            const currentDate = getCurrentDate();

            if (!student || !subject || !grade) {
                alert('Заполните все поля!');
                return;
            }

            const gradeNum = parseInt(grade);
            if (gradeNum < 2 || gradeNum > 5) {
                alert('Оценка должна быть от 2 до 5!');
                return;
            }

            allStudentGrades = allStudentGrades.filter(g =>
                !(g.student === student && g.subject === subject && g.date === currentDate)
            );

            allStudentGrades.push({
                id: Date.now() + Math.random(),
                student: student,
                subject: subject,
                grade: grade,
                date: currentDate,
                quarter: getQuarterByDate(currentDate)
            });

            updateGradesHistory();
            saveToLocalStorage();
            alert(`Оценка ${grade} по предмету "${subject}" добавлена ученику ${student}`);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active-tab');
            });
            document.getElementById(tabId).classList.add('active-tab');
        }

        function switchAdminTab(tabId) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active-tab');
            });
            document.getElementById(tabId).classList.add('active-tab');
        }

        function updateDiary() {
            currentDayElement.textContent = currentDay;
            const todaySchedule = schedule[currentDay] || [];
            const lessonsCount = todaySchedule.filter(lesson =>
                !['Завтрак', 'Обед', 'Ужин'].includes(lesson)
            ).length;
            lessonCountElement.textContent = lessonsCount;
            scheduleElement.innerHTML = '';

            todaySchedule.forEach((lesson, index) => {
                const lessonElement = document.createElement('div');
                lessonElement.className = 'lesson';
                const isMeal = ['Завтрак', 'Обед', 'Ужин'].includes(lesson);

                lessonElement.innerHTML = `
                    <div class="lesson-number">${index + 1}</div>
                    <div class="lesson-name">
                        ${lesson}
                        ${isMeal ? '<span class="lesson-counter">Прием пищи</span>' : ''}
                    </div>
                    <div class="lesson-time">${getLessonTime(index)}</div>
                `;

                scheduleElement.appendChild(lessonElement);
            });
        }

        function getLessonTime(lessonIndex) {
            const startTimes = ["8:00", "8:50", "9:45", "10:40", "11:35", "12:30", "13:25", "14:20", "15:15", "16:10"];
            return startTimes[lessonIndex] || "---";
        }

        function updateGrades() {
            gradesListElement.innerHTML = '';
            const gradesBySubject = getGradesBySubject(currentUser, currentQuarter);
            let totalSum = 0;
            let totalCount = 0;

            allSubjects.forEach(subject => {
                const grades = gradesBySubject[subject] || [];
                let average = "—";
                if (grades.length > 0) {
                    const sum = grades.reduce((a, b) => a + b, 0);
                    average = (sum / grades.length).toFixed(2);
                    totalSum += sum;
                    totalCount += grades.length;
                }

                const gradeRow = document.createElement('div');
                gradeRow.className = 'stats-row';
                const gradesHTML = grades.map(grade =>
                    `<div class="grade-bubble grade-${grade}">${grade}</div>`
                ).join('');
                const gradesCount = grades.length > 0 ? `<span class="subject-count">(${grades.length} оценок)</span>` : '';

                gradeRow.innerHTML = `
                    <div class="subject-col">${subject} ${gradesCount}</div>
                    <div class="grades-col">${gradesHTML || "Нет оценок"}</div>
                    <div class="average-col">${average}</div>
                `;

                gradesListElement.appendChild(gradeRow);
            });

            const overallAverage = totalCount > 0 ? (totalSum / totalCount).toFixed(2) : "0.00";
            quarterAverageElement.textContent = overallAverage;
        }

        function updateProfile() {
            profileLoginInput.value = currentUser;
        }

        function saveProfile() {
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();

            if (newPassword && newPassword !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }

            if (newPassword) {
                users[currentUser].password = newPassword;
                alert('Пароль успешно изменен!');
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            }

            saveToLocalStorage();
            alert('Изменения сохранены!');
        }

        function updateStudentsList() {
            studentsListElement.innerHTML = '';

            for (const username in users) {
                if (users[username].role === 'user') {
                    const user = users[username];
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.setAttribute('data-login', username);

                    studentItem.innerHTML = `
                        <div>
                            <div class="student-login">${username}</div>
                            <div class="student-password">Пароль: ${user.password}</div>
                        </div>
                        <button class="edit-btn" data-username="${username}">Изменить</button>
                    `;

                    studentItem.addEventListener('click', function(e) {
                        if (e.target.classList.contains('edit-btn')) {
                            const username = e.target.getAttribute('data-username');
                            editStudent(username);
                        } else {
                            const username = this.getAttribute('data-login');
                            loginAsStudent(username);
                        }
                    });

                    studentsListElement.appendChild(studentItem);
                }
            }
        }

        function filterStudents() {
            const searchText = studentSearchInput.value.toLowerCase();
            const studentItems = studentsListElement.querySelectorAll('.student-item');

            studentItems.forEach(item => {
                const login = item.getAttribute('data-login').toLowerCase();
                if (login.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function editStudent(username) {
            const newPassword = prompt(`Введите новый пароль для ${username}:`, users[username].password);

            if (newPassword !== null) {
                users[username].password = newPassword;
                updateStudentsList();
                saveToLocalStorage();
                alert('Пароль изменен!');
            }
        }

        function loginAsStudent(username) {
            if (confirm(`Вы хотите войти в аккаунт ученика ${username}?`)) {
                currentUser = username;
                showUserInterface();
            }
        }

        function updateGradesHistory() {
            gradesHistoryBody.innerHTML = '';

            if (allStudentGrades.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">Нет оценок</td>`;
                gradesHistoryBody.appendChild(row);
                return;
            }

            allStudentGrades.forEach(grade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${grade.student}</td>
                    <td>${grade.subject}</td>
                    <td><div class="grade-bubble grade-${grade.grade}">${grade.grade}</div></td>
                    <td>${formatDate(grade.date)}</td>
                    <td><button class="delete-grade-btn" data-id="${grade.id}">Удалить</button></td>
                `;

                row.querySelector('.delete-grade-btn').addEventListener('click', function() {
                    const id = parseFloat(this.getAttribute('data-id'));
                    deleteGrade(id);
                });

                gradesHistoryBody.appendChild(row);
            });
        }

        function deleteGrade(id) {
            if (confirm('Вы уверены, что хотите удалить эту оценку?')) {
                allStudentGrades = allStudentGrades.filter(grade => grade.id !== id);
                updateGradesHistory();
                saveToLocalStorage();
                updateSubjectsForGrades();
            }
        }

        function deleteAllGrades() {
            if (confirm('ВНИМАНИЕ! Вы уверены, что хотите удалить ВСЕ оценки? Это действие нельзя отменить!')) {
                allStudentGrades = [];
                updateGradesHistory();
                saveToLocalStorage();
                updateSubjectsForGrades();
                alert('Все оценки удалены!');
            }
        }

        function saveToLocalStorage() {
            const data = {
                users: users,
                allStudentGrades: allStudentGrades
            };
            localStorage.setItem('eJournalData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('eJournalData');

            if (savedData) {
                try {
                    const data = JSON.parse(savedData);

                    if (data.users) {
                        for (const username in data.users) {
                            if (users[username]) {
                                users[username] = {...users[username], ...data.users[username]};
                            }
                        }
                    }

                    if (data.allStudentGrades && data.allStudentGrades.length > 0) {
                        allStudentGrades = data.allStudentGrades;
                    }
                } catch (e) {
                    console.error('Ошибка при загрузке данных:', e);
                }
            }
        }
    </script>
</body>
</html>